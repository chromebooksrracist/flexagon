<meta charset="UTF-8">
<html>

<head>
  <title>Flexagon Explorer</title>
  <script src="../build/out.js"></script>
  <script type="text/javascript">
    var fm;
    var explorer;
    var cancelled = false;

    function runScript() {
      statusMessage("error parsing script");
      var scriptBox = document.getElementById('script');
      if (scriptBox === null) {
        return false;
      }
      var result = Flexagonator.RunScriptString(fm, scriptBox.value);
      if (Flexagonator.isFlexError(result) || Flexagonator.isTreeError(result)) {
        var str = Flexagonator.errorToString(result);
        statusMessage(str);
        return false;
      }
      fm = result;
      return true;
    }

    function startExplore(includeOver) {
      if (runScript()) {
        cancelled = false;
        var over = includeOver ? fm.allFlexes['^'] : undefined;
        explorer = new Flexagonator.Explore(fm.flexagon, fm.flexesToSearch, fm.allFlexes['>'], over);
        explore(explorer);
      }
    }

    function explore(explorer) {
      if (cancelled) {
        statusMessage("CANCELLED after " + explorer.getTotalStates() + " states");
        return;
      }
      while (explorer.checkNext()) {
        if (explorer.getExploredStates() % 50 == 0) {
          var str = "explored " + explorer.getExploredStates() + " states, found " + explorer.getTotalStates() + " states";
          statusMessage(str);
          setTimeout(explore, 0, explorer);
          return;
        }
      }

      var str = "DONE: found " + explorer.getTotalStates() + " states";
      str += " - (" + fm.flexagon.getLeafCount() + " leaves)";
      statusMessage(str);
    }

    function cancel() {
      cancelled = true;
    }

    function statusMessage(message) {
      var statusDiv = document.getElementById('status');
      if (statusDiv !== null) {
        statusDiv.innerHTML = message;
      }
    }

    function showStates(flexagons) {
      var box = document.getElementById('states');
      if (box !== null) {
        var str = "";
        for (var i = 0; i < flexagons.length; i++) {
          var tree = flexagons[i].getAsLeafTrees();
          str += i.toString() + ": " + JSON.stringify(tree) + '\n';
        }
        box.value = str;
      }
    }

    function showFlexes(found) {
      var box = document.getElementById('states');
      if (box !== null) {
        var str = "";
        for (var i = 0; i < found.length; i++) {
          var s = i.toString() + ": " + Flexagonator.relativeFlexesToString(found[i]) + '\n';
          str += s;
        }
        box.value = str;
      }
    }

    function showCounts(found) {
      var box = document.getElementById('states');
      if (box !== null) {
        var flexCounts = Flexagonator.countStatesThatSupportFlexes(found);
        var str = "states that support flexes\n\n";
        var entries = Object.entries(flexCounts);
        for (var i = 0; i < entries.length; i++) {
          var line = entries[i][0] + '\t' + entries[i][1] + '\n';
          str += line;
        }
        box.value = str;
      }
    }

    function showDotSimple(found) {
      var box = document.getElementById('states');
      if (box !== null) {
        box.value = Flexagonator.DotSimple(found);
      }
    }

    function showDotFlexes(found, oneway) {
      var box = document.getElementById('states');
      if (box !== null) {
        box.value = Flexagonator.DotWithFlexes(found, oneway);
      }
    }
  </script>
</head>

<body>
  <h1>Flexagon Explorer</h1>

  <p>
    Run a script to describe a flexagon, then explore all the states of that flexagon.
  </p>

  <p>
    <input onclick="startExplore(true);" type="button" value="explore" />
    <input onclick="startExplore(false);" type="button" value="explore (no ^)" /> -
    <input onclick="cancel();" type="button" value="cancel" />
  </p>

  <p>
    <textarea id="script" cols="100" rows="7" spellcheck="false"></textarea>
  </p>

  <div id="status"></div>

  <p>
    <input onclick="showStates(explorer.getFlexagons());" type="button" value="show states" />
    <input onclick="showFlexes(explorer.getFoundFlexes());" type="button" value="show flexes" />
    <input onclick="showCounts(explorer.getFoundFlexes());" type="button" value="show counts" />
    <input onclick="showDotSimple(explorer.getFoundFlexes());" type="button" value="DOT: state to state" />
    <input onclick="showDotFlexes(explorer.getFoundFlexes(), true);" type="button" value="DOT: flexes" />
    <input onclick="showDotFlexes(explorer.getFoundFlexes(), false);" type="button" value="DOT: directed flexes" />
  </p>

  <p>
    <textarea id="states" cols="100" rows="30" spellcheck="false" readonly="true"></textarea>
  </p>
</body>

</html>
